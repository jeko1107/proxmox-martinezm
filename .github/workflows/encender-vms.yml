name: Encender VMs cada 8 horas

on:
  schedule:
    - cron: '0 */8 * * *'  # 00:00, 08:00, 16:00 UTC
  workflow_dispatch:

jobs:
  encender:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Instalar OpenVPN
        run: |
          sudo apt update -qq
          sudo apt install -y openvpn

      - name: Crear archivos OpenVPN
        run: |
          echo "$OPENVPN_CONFIG" > /tmp/instituto.ovpn
          echo "$OPENVPN_AUTH" > /tmp/auth.txt
          echo "$OPENVPN_CACERT" > /tmp/cacert.pem
          chmod 600 /tmp/*
        env:
          OPENVPN_CONFIG: ${{ secrets.OPENVPN_CONFIG }}
          OPENVPN_AUTH: ${{ secrets.OPENVPN_AUTH }}
          OPENVPN_CACERT: ${{ secrets.OPENVPN_CACERT }}

      - name: Ejecutar script
        run: python start_vms_openvpn.py
        env:
          PROXMOX_IP: ${{ secrets.PROXMOX_IP }}
          PROXMOX_TOKEN: ${{ secrets.PROXMOX_TOKEN }}

      - name: Limpiar
        if: always()
        run: |
          rm -f /tmp/instituto.ovpn /tmp/auth.txt /tmp/cacert.pem
          pkill openvpn || true
