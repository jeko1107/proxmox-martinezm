# .github/workflows/encender-vms.yml
name: Encender VMs Proxmox (7:00 AM y 3:30 PM España)

on:
  schedule:
    - cron: '0 5 * * *'
    - cron: '30 13 * * *'
  workflow_dispatch:

jobs:
  encender:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      packages: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Instalar OpenVPN
        run: sudo apt update -qq && sudo apt install -y openvpn iproute2

      - name: Crear archivos OpenVPN
        run: |
          echo "$OPENVPN_CONFIG" > /tmp/instituto.ovpn
          echo "$OPENVPN_AUTH" > /tmp/auth.txt
          echo "$OPENVPN_CACERT" > /tmp/cacert.pem
          chmod 600 /tmp/instituto.ovpn /tmp/auth.txt /tmp/cacert.pem

      - name: Conectar OpenVPN (con sudo)
        run: |
          sudo openvpn \
            --config /tmp/instituto.ovpn \
            --auth-user-pass /tmp/auth.txt \
            --ca /tmp/cacert.pem \
            --log /tmp/openvpn.log \
            --daemon
          echo "OpenVPN iniciado con sudo..."
          sleep 30  # Espera conexión

      - name: Verificar conexión VPN
        run: |
          ip link show type tun || ip link show type tap
          ping -c 1 ${{ secrets.PROXMOX_IP }} || exit 1

      - name: Ejecutar script
        run: python start_vms_openvpn.py
        env:
          PROXMOX_IP: ${{ secrets.PROXMOX_IP }}
          PROXMOX_TOKEN: ${{ secrets.PROXMOX_TOKEN }}

      - name: Limpiar
        if: always()
        run: |
          sudo pkill openvpn || true
          sudo rm -f /tmp/instituto.ovpn /tmp/auth.txt /tmp/cacert.pem /tmp/openvpn.log
