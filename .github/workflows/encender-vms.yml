# .github/workflows/encender-vms.yml
name: Encender VMs Proxmox (7:00 AM y 3:30 PM España)

on:
  schedule:
    - cron: '0 5 * * *'   # 7:00 AM España
    - cron: '30 13 * * *' # 3:30 PM España
  workflow_dispatch:

jobs:
  encender:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Instalar OpenVPN
        run: sudo apt update -qq && sudo apt install -y openvpn iproute2

      - name: Crear config OpenVPN con fuerza
        run: |
          # Guardar .ovpn original
          echo "$OPENVPN_CONFIG" | sudo tee /tmp/instituto.ovpn > /dev/null

          # Extraer bloques embebidos (ca, cert, key, tls-auth)
          sudo awk '
            /^<ca>$/ { in_block = 1; block = "cacert.pem"; next }
            /^<cert>$/ { in_block = 1; block = "client.crt"; next }
            /^<key>$/ { in_block = 1; block = "client.key"; next }
            /^<tls-auth>$/ { in_block = 1; block = "ta.key"; next }
            /^<\/.*>$/ { in_block = 0 }
            in_block { print > "/tmp/" block }
            !in_block { print > "/tmp/config_clean.ovpn" }
          ' /tmp/instituto.ovpn

          sudo mv /tmp/config_clean.ovpn /tmp/instituto.ovpn

          # FORZAR CONFIGURACIÓN MÍNIMA
          cat | sudo tee /tmp/instituto.ovpn > /dev/null << 'EOF'
client
tls-client
dev tun
proto udp
remote proxmox.iesmartinezm.es 1194
remote 192.168.1.100 1194
resolv-retry infinite
persist-key
persist-tun
auth-user-pass
verb 3
data-ciphers AES-256-GCM:AES-128-GCM:BF-CBC
data-ciphers-fallback BF-CBC
EOF

          # Añadir ca embebido si existe
          [ -f /tmp/cacert.pem ] && sudo sed -i '/^ca /d' /tmp/instituto.ovpn && echo "ca /tmp/cacert.pem" | sudo tee -a /tmp/instituto.ovpn > /dev/null

          # auth.txt
          echo "$OPENVPN_AUTH" | sudo tee /tmp/auth.txt > /dev/null
          sudo chmod 600 /tmp/instituto.ovpn /tmp/auth.txt /tmp/cacert.pem 2>/dev/null || true

      - name: Conectar OpenVPN
        run: |
          echo "Iniciando OpenVPN..."
          sudo openvpn \
            --config /tmp/instituto.ovpn \
            --auth-user-pass /tmp/auth.txt \
            --log /tmp/openvpn.log \
            --verb 4 \
            --connect-timeout 40 &
          OPENVPN_PID=$!
          sleep 50
          if ! sudo kill -0 $OPENVPN_PID 2>/dev/null; then
            echo "OpenVPN falló. Logs:"
            sudo cat /tmp/openvpn.log
            exit 1
          fi
          echo "OpenVPN conectado."

      - name: Verificar conexión
        run: |
          sudo ip link show tun0
          ping -c 2 ${{ secrets.PROXMOX_IP }}

      - name: Ejecutar script
        run: python start_vms_openvpn.py
        env:
          PROXMOX_IP: ${{ secrets.PROXMOX_IP }}
          PROXMOX_TOKEN: ${{ secrets.PROXMOX_TOKEN }}

      - name: Limpiar
        if: always()
        run: |
          sudo pkill openvpn || true
          sudo rm -f /tmp/instituto.ovpn /tmp/auth.txt /tmp/cacert.pem /tmp/openvpn.log
